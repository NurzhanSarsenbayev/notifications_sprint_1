
---

# üèõ ARCHITECTURE ‚Äî Notification Service

–°–µ—Ä–≤–∏—Å –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –æ–Ω–ª–∞–π–Ω-–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –¥–æ—Å—Ç–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ —Å–æ–±—ã—Ç–∏—è–º, –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –≤–æ–∫—Ä—É–≥ —Å–≤—è–∑–∫–∏:

> **HTTP API ‚Üí Kafka ‚Üí Worker ‚Üí Postgres (+ DLQ)**

---

## 1. üß© –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1.1. Notification API (FastAPI)

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≤—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π.

**–ó–∞–¥–∞—á–∏:**

* –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è `Event` –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (Auth, Content, UGC, Admin);
* –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏—è –∏ `payload`;
* –º–∞–ø–ø–∏—Ç —Å–æ–±—ã—Ç–∏—è –≤ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π `NotificationJob`;
* –ø—É–±–ª–∏–∫—É–µ—Ç `NotificationJob` –≤ Kafka-—Ç–æ–ø–∏–∫ `notifications.outbox`;
* –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç CRUD –ø–æ —à–∞–±–ª–æ–Ω–∞–º –ø–∏—Å—å–º–∞ (`templates`).

**–í–∞–∂–Ω–æ:**

* API **–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** ‚Äî –æ–Ω —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –∑–∞–¥–∞–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å.
* –í —Å–ª—É—á–∞–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Kafka –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ ¬´–¥–µ–≥—Ä–∞–¥–∏—Ä—É—é—â–µ–º¬ª —Ä–µ–∂–∏–º–µ (dummy publisher), –ª–æ–≥–∏—Ä—É—è job –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.

---

### 1.2. Kafka

–ë—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è API –∏ worker.

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–æ–ø–∏–∫–∏:**

| –¢–æ–ø–∏–∫                  | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                               |
| ---------------------- | -------------------------------------------------------- |
| `notifications.outbox` | –û—Å–Ω–æ–≤–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á `NotificationJob`                 |
| `notifications.dlq`    | Dead Letter Queue: –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å |

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ:**

* Retry-–ª–æ–≥–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–≤–Ω—É—Ç—Ä–∏ –≤–æ—Ä–∫–µ—Ä–∞**, –∞ –Ω–µ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π retry-—Ç–æ–ø–∏–∫.
* –°–µ–º–∞–Ω—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: **at-least-once** (–≤–æ–∑–º–æ–∂–Ω—ã –ø–æ–≤—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≥–∞—Å–∏–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é –ø–æ `job_id`).

---

### 1.3. Notification Worker

–û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å (—Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å), –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –¥–æ—Å—Ç–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–ó–∞–¥–∞—á–∏:**

1. –ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Kafka-—Ç–æ–ø–∏–∫–∞ `notifications.outbox`.
2. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è `NotificationJob`.
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ `job_id` (–ø–æ —Ç–∞–±–ª–∏—Ü–µ `notification_delivery`).
4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ä–æ–∫–∞ –≥–æ–¥–Ω–æ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (`expires_at`) –∏ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (`send_after`).
5. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `AuthClient` (—Å–µ–π—á–∞—Å stub).
6. –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `templates`.
7. –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è (`subject`, `body`) –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞ –∏ `job.data`.
8. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –Ω—É–∂–Ω–æ–º—É –∫–∞–Ω–∞–ª—É (`email` / `push` / `ws`) —á–µ—Ä–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π sender.
9. –ó–∞–ø–∏—Å—å —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É `notification_delivery`.
10. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ DLQ (`notifications.dlq`) –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ.

Worker **–Ω–µ –∏–º–µ–µ—Ç HTTP API** –∏ –æ–±—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å Kafka –∏ Postgres.

---

### 1.4. Postgres

–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è:

* —à–∞–±–ª–æ–Ω–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π (`templates`);
* –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ—Å—Ç–∞–≤–æ–∫ (`notification_delivery`).

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:

* –≤ API ‚Äî SQLAlchemy (async engine);
* –≤ worker ‚Äî `asyncpg` (—á–µ—Ä–µ–∑ –ø—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π).

---

### 1.5. –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`notifications.common`)

–û–±—â–∏–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ API, –∏ worker:

* `config` ‚Äî –æ–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Kafka, Postgres, retry, send_after –∏ —Ç.–¥.);
* `schemas` ‚Äî Pydantic-—Å—Ö–µ–º—ã (–≤ —Ç.—á. `NotificationJob`, `NotificationMeta`, `NotificationChannel`, `NotificationStatus`);
* `db` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–Ω–∏–µ `AsyncSession` (–¥–ª—è API);
* `kafka` ‚Äî –æ–±—ë—Ä—Ç–∫–∞ Kafka-–ø—É–±–ª–∏–∫–∞—Ç–æ—Ä–∞ (`KafkaNotificationJobPublisher`) –∏ dummy-—Ä–µ–∂–∏–º.

---

### 1.6. Campaign Scheduler (MVP-–∑–∞–¥–µ–ª)

–û—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ—Å—Ç—è–∫), –∫–æ—Ç–æ—Ä—ã–π –≤ –±—É–¥—É—â–µ–º:

* –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é;
* —Ö–æ–¥–∏—Ç—å –≤ Notification API –∏–ª–∏ –ø–∏—Å–∞—Ç—å job‚Äô—ã –Ω–∞–ø—Ä—è–º—É—é –≤ Kafka;
* —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∞–±–ª–∏—Ü–µ–π `campaigns`.

–í —Ç–µ–∫—É—â–µ–º MVP –ª–æ–≥–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π –∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞** ‚Äî –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∑–∞–¥–µ–ª.

---

## 2. üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–∏–¥:

```text
src/
  notifications/
    common/                 # –æ–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏/—Å—Ö–µ–º—ã/–æ–±—ë—Ä—Ç–∫–∏
      config.py
      db.py
      kafka.py
      schemas/
        notification_job.py
        notification_enums.py
        ...
    notifications_api/      # HTTP API
      main.py
      api/v1/
        events.py           # POST /api/v1/events
        templates.py        # CRUD –ø–æ —à–∞–±–ª–æ–Ω–∞–º
      services/
        notification_service.py  # Event ‚Üí NotificationJob ‚Üí publish
      repositories/
        templates.py
      schemas/
        event.py
        template.py
      utils/
        dependencies.py
    worker/                 # Notification Worker
      main.py
      startup.py            # —Å–æ–∑–¥–∞–Ω–∏–µ Kafka producer –∏ PG pool
      consumer/
        kafka_consumer.py   # —á—Ç–µ–Ω–∏–µ job –∏–∑ Kafka
      processor/
        job_processor.py    # –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ job
        retry_engine.py     # –≥–ª–æ–±–∞–ª—å–Ω—ã–π retry-—Ü–∏–∫–ª
        status_writer.py    # –∑–∞–ø–∏—Å—å —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ë–î
        timing.py           # send_after / expires_at
      repositories/
        template_repo.py
        notification_delivery_repo.py
      senders/
        base.py             # –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å BaseSender
        email_sender.py
        push_sender.py      # stub
        ws_sender.py        # stub
      auth/
        client.py           # AuthClient (stub)
      dlq/
        publisher.py        # –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ notifications.dlq
```

---

## 3. üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (end-to-end)

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π `user_registered`.

```text
[Auth Service]
    |
    | 1. POST /api/v1/events (event_type = "user_registered")
    v
[Notification API]
    |
    | 2. –í–∞–ª–∏–¥–∞—Ü–∏—è BaseEvent + UserRegisteredEventPayload
    | 3. –ú–∞–ø–ø–∏–Ω–≥ –≤ NotificationJob (channel=email, template_code="welcome_email")
    | 4. –ü—É–±–ª–∏–∫–∞—Ü–∏—è job –≤ Kafka (notifications.outbox)
    v
[Kafka: notifications.outbox]
    |
    | 5. KafkaNotificationConsumer —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    v
[Notification Worker]
    |
    | 6. –í–∞–ª–∏–¥–∞—Ü–∏—è JSON ‚Üí NotificationJob
    | 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ job_id –≤ notification_delivery (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
    | 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ expires_at / send_after
    | 9. –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ AuthClient (stub)
    |10. –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ (templates)
    |11. –†–µ–Ω–¥–µ—Ä subject/body
    |12. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ EmailSender (MVP: –ª–æ–≥)
    |13. –ó–∞–ø–∏—Å—å —Å—Ç–∞—Ç—É—Å–∞ SENT –≤ notification_delivery
    v
[Postgres: notification_delivery]
```

–ü—Ä–∏ –æ—à–∏–±–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç email, –Ω–µ –Ω–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω, runtime-exception) –≤–∫–ª—é—á–∞–µ—Ç—Å—è **Retry Engine**:

* –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ –∑–∞–¥–µ—Ä–∂–µ–∫;
* —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–µ–π–ª ‚Üí –∑–∞–ø–∏—Å—å —Å—Ç–∞—Ç—É—Å–∞ `FAILED` –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –≤ `notifications.dlq`.

---

## 4. üì¶ –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ–¥—Ä–æ–±–Ω–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –æ–ø–∏—Å–∞–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö:

* [EVENTS.md](EVENTS.md) ‚Äî —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π `Event`, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç API;
* [QUEUE_JOBS.md](QUEUE_JOBS.md) ‚Äî —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π `NotificationJob` –≤ Kafka.

–ó–¥–µ—Å—å –≤–∞–∂–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å:

### 4.1. Event ‚Üí NotificationJob

API –æ–ø–µ—Ä–∏—Ä—É–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–µ–π `BaseEvent`:

```json
{
  "event_id": "uuid",
  "event_type": "user_registered",
  "source": "auth_service",
  "occurred_at": "ISO datetime",
  "payload": { ... }
}
```

–í–Ω—É—Ç—Ä–∏ `NotificationService` —Å–æ–±—ã—Ç–∏–µ –º–∞–ø–ø–∏—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ `NotificationJob`.

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç:

* `user_registered` ‚Äî **—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω**, —Å–æ–∑–¥–∞—ë—Ç –æ–¥–∏–Ω `NotificationJob` –Ω–∞ `user_id`;
* `new_film_released` ‚Äî —Å—Ö–µ–º–∞ —Å–æ–±—ã—Ç–∏—è –µ—Å—Ç—å, –Ω–æ –º–∞–ø–ø–∏–Ω–≥ –≤ job **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫** (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ);
* `campaign_triggered` ‚Äî —Ç–∞–∫–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ, –Ω–æ –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è job –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (–≤–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞).

### 4.2. NotificationJob –≤ Kafka

Worker –æ–ø–µ—Ä–∏—Ä—É–µ—Ç `NotificationJob`:

```json
{
  "job_id": "uuid",
  "user_id": "uuid",
  "channel": "email",
  "template_code": "welcome_email",
  "locale": "ru",
  "data": { ... },
  "meta": {
    "event_type": "user_registered",
    "event_id": "uuid",
    "campaign_id": null,
    "priority": "normal"
  },
  "created_at": "ISO datetime",
  "send_after": null,
  "expires_at": null
}
```

---

## 5. üîÅ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ retry

### 5.1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ `notification_delivery`:

* –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π job –≤–æ—Ä–∫–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ `job_id`;
* –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ `SENT` –∏–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π `FAILED` / `EXPIRED` –ø—Ä–∏ `>= max_attempts` ‚Äî job **–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è**.

### 5.2. Retry Engine

Retry-–∫–æ–Ω—Ç—É—Ä —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `RetryEngine`:

* –º–∞–∫—Å–∏–º—É–º `max_attempts` (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞);
* –∑–∞–¥–µ—Ä–∂–∫–∏ –∏–∑ `retry_delays_seconds` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `[1, 3, 10]`);
* –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏:

  * —Å—Ç–∞—Ç—É—Å `RETRYING` –∏–ª–∏ `FAILED` (–µ—Å–ª–∏ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã);
  * –ø—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–µ–π–ª–µ ‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ `notifications.dlq`.

### 5.3. Expiration / send_after

* `expires_at` ‚Äî –µ—Å–ª–∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, job –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `EXPIRED` –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è;
* `send_after` ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ª–æ–∂–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É (–≤–æ—Ä–∫–µ—Ä –∂–¥—ë—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ –Ω–µ –¥–æ–ª—å—à–µ `max_send_delay_seconds`).

---

## 6. üåê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### 6.1. Auth Service

–°–µ–π—á–∞—Å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `AuthClient` (stub):

* –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ `user_id`;
* –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –≤—ã–¥–µ–ª–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å ‚Üí –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π HTTP/gRPC-–∫–ª–∏–µ–Ω—Ç.

### 6.2. –ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏

–°–ª–æ–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ `senders`:

* `EmailSender` ‚Äî –≤ MVP –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É;
* `PushSender` –∏ `WsSender` ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ (–≥–æ—Ç–æ–≤—ã –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é).

–í –±—É–¥—É—â–µ–º –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞:

* SMTP / –≤–Ω–µ—à–Ω–∏–µ email-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã;
* push-—à–ª—é–∑—ã (FCM, APNs –∏ —Ç.–ø.);
* WebSocket-gateway.

JobProcessor –Ω–µ –∑–∞–≤—è–∑–∞–Ω –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é ‚Äî –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.

---

## 7. üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### 7.1. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Worker

* –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ Notification Worker –≤—Ö–æ–¥—è—Ç –≤ –æ–¥–Ω—É consumer group (`notification-worker`);
* Kafka —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Ç–æ–ø–∏–∫–∞ `notifications.outbox` –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏;
* –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —á–∏—Å–ª—É –≤–æ—Ä–∫–µ—Ä–æ–≤.

### 7.2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏

* –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (Auth, email-provider –∏ —Ç.–¥.) –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è:

  * –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ worker;
  * –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ Kafka (—á–∏—Å–ª–æ –ø–∞—Ä—Ç–∏—Ü–∏–π, max poll records –∏ —Ç.–ø.);
  * retry-—Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π.

---

## 8. üìå –°—Ç–∞—Ç—É—Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω **MVP Notification Service**:

* –µ—Å—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π API –¥–ª—è –ø—Ä–∏—ë–º–∞ —Å–æ–±—ã—Ç–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞–º–∏;
* –µ—Å—Ç—å Kafka-—Ç–æ–ø–∏–∫–∏ `notifications.outbox` –∏ `notifications.dlq`;
* –µ—Å—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π worker —Å:

  * –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é,
  * retry-–ª–æ–≥–∏–∫–æ–π,
  * –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `send_after` / `expires_at`,
  * –∑–∞–ø–∏—Å—å—é —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ Postgres;
* –µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è Auth-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏.

–°–ª–µ–¥—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –∑–∞–¥–µ–ª–æ–º** –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Ä–∞–±–æ—Ç–∞–Ω—ã –ø–æ–∑–∂–µ:

* —Ä–µ–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Auth/email/push/ws;
* –ª–æ–≥–∏–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–∞–º–ø–∞–Ω–∏–π;
* –æ—Ç–¥–µ–ª—å–Ω—ã–π campaign scheduler —Å cron/periodic –∑–∞–¥–∞—á–∞–º–∏;
* –æ—Ç–¥–µ–ª—å–Ω—ã–π WebSocket-—Å–µ—Ä–≤–∏—Å –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π;
* admin-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏.

---