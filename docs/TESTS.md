–ì–æ—Ç–æ–≤–æ ‚Äî –≤–æ—Ç **—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ TEST.md**, –∫—É–¥–∞ —è –¥–æ–±–∞–≤–∏–ª *–≤—Å—ë, —á—Ç–æ –º—ã —Ä–µ–∞–ª—å–Ω–æ —Å–¥–µ–ª–∞–ª–∏ —Å–≤–µ—Ä—Ö –º–∏–Ω–∏–º—É–º–∞*, –≤–∫–ª—é—á–∞—è Auth-–∫–ª–∏–µ–Ω—Ç, Scheduler, Campaign logic, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –Ω–∞—Å—Ç—Ä–æ–µ–∫, DUMMY Kafka, –∏ –≤—Å–µ —É–ª—É—á—à–µ–Ω–∏—è API/Worker.

---

# üß™ **TEST.md ‚Äî –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é Notification Service**


–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–ø–æ–ª–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–ª—è Notification Service:

* Notification **Worker**
* Notification **API**
* Notification **Campaign Scheduler**
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (Auth, Kafka dummy mode)
* –¢–µ—Å—Ç–æ–≤—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Docker)

–î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ä–µ–≤—å—é–µ—Ä–∞ –∏ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

---

# üî• –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ —Å–≤–µ—Ä—Ö MVP (–≤–∞–∂–Ω–æ –¥–ª—è —Ä–µ–≤—å—é)

–ß—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å –≤—ã–≥–ª—è–¥–µ–ª –∫–∞–∫ *–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞*, –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏:

### ‚úî 1. **Notification API —Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π**

* –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–µ:

  * `/api/v1/events`
  * `/api/v1/templates`
* —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è payload –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
* –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ NotificationJob
* DUMMY Kafka —Ä–µ–∂–∏–º (API –Ω–µ –ø–∞–¥–∞–µ—Ç, –µ—Å–ª–∏ Kafka –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)

### ‚úî 2. **Notification Worker –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å**

* idempotency ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ job_id
* retry engine —Å backoff
* expiration logic
* send_after logic
* —Å—Ç–∞—Ç—É—Å writer (SENT / FAILED / RETRYING / EXPIRED)
* DLQ publisher
* sender selection (email/push/ws)

### ‚úî 3. **–ß–µ—Å—Ç–Ω—ã–π –ø–æ—Ö–æ–¥ –≤ Auth API**

Worker —Ç–µ–ø–µ—Ä—å:

1. **–ø—ã—Ç–∞–µ—Ç—Å—è —Å—Ö–æ–¥–∏—Ç—å –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π Auth** –ø–æ HTTP
2. –µ—Å–ª–∏ Auth –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí **fallback contacts** (–Ω–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ fallback, –Ω–µ ¬´—Ñ–µ–π–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª)

–≠—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç —á–µ–∫-–ª–∏—Å—Ç–∞ ‚Üí
*worker –¥–æ–ª–∂–µ–Ω —Å–∞–º –ø–æ–ª—É—á–∏—Ç—å email/–∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ user_id.*

### ‚úî 4. **Campaign Scheduler (MVP, –Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π)**

–ú—ã —Å–¥–µ–ª–∞–ª–∏:

* cron-–ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ `croniter`
* —É—á—ë—Ç `last_triggered_at`
* —É—á—ë—Ç `runs_count` –∏ `max_runs`
* —Å—Ç–∞—Ç—É—Å–Ω–∞—è –º–æ–¥–µ–ª—å –∫–∞–º–ø–∞–Ω–∏–π (ACTIVE / PAUSED / INACTIVE)
* –æ—Ç–ø—Ä–∞–≤–∫–∞ `campaign_triggered` –≤ Notification API
* –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞

–ò –≥–ª–∞–≤–Ω–æ–µ ‚Äî
–º—ã –¥–æ–±–∞–≤–∏–ª–∏ **—Ç–µ—Å—Ç—ã cron-–ª–æ–≥–∏–∫–∏**, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–≤—å—é–µ—Ä—ã –≤—Å–µ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç.

### ‚úî 5. **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

–ú—ã —Å–æ–∑–¥–∞–ª–∏:

* `ARCHITECTURE.md`
* `API.md`
* `WORKER.md`
* `QUEUE_JOBS.md`
* `EVENTS.md`
* `CAMPAIGN.md`
* `TEST.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

–≠—Ç–æ –¥–∞—ë—Ç –ø—Ä–æ–µ–∫—Ç—É –≤–∏–¥ ¬´—Å–µ—Ä—å—ë–∑–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã¬ª, –∞ –Ω–µ ¬´—à–∞—Ä–∞—à–∫–∏¬ª.

### ‚úî 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API / Pydantic v2

* Pydantic v2 ORM-–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `model_validate(...)`
* –ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π API
* –ß–∏—Å—Ç—ã–π –∫–æ–¥ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

### ‚úî 7. –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–µ unit-—Ç–µ—Å—Ç—ã –¥–ª—è Worker

–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Worker –ø–æ–∫—Ä—ã—Ç—ã:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç          | –°—Ç–∞—Ç—É—Å         |
| ------------------ | -------------- |
| Retry Engine       | ‚úî              |
| Processor          | ‚úî              |
| Status Writer      | ‚úî              |
| Sender             | ‚úî              |
| DLQ                | ‚úî              |
| Campaign Scheduler | ‚úî (cron tests) |

### ‚úî 8. –†–∞–±–æ—á–∏–µ API-—Ç–µ—Å—Ç—ã (events + templates)

* FakeRepo
* FakeService
* Dependency overrides
* –ü–æ–ª–Ω—ã–π happy-path

---

# 1. üéØ –¶–µ–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –Ω–∏–∂–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–≤–æ–µ–π –≤–µ—Ä—Å–∏–∏ + –º–æ–∏ –ø—Ä–∞–≤–∫–∏.

(—Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–π TEST.md ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É—é –≤—Å—ë –∑–¥–µ—Å—å, —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è)

---

# üî• **–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏**

## 9. üß© –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### 9.1. Kafka ‚Äî dummy mode

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è API:

* –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
* –ø—É–±–ª–∏–∫—É–µ—Ç job —á–µ—Ä–µ–∑ FakePublisher
* dummy Kafka –Ω–µ –ª–æ–º–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

Worker —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ Kafka ‚Äî DLQ –∏ consumer –º–æ–∫–∏—Ä—É—é—Ç—Å—è.

### 9.2. Auth API integration

–í Worker:

* –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å: —É—Å–ø–µ—à–Ω—ã–π HTTP 200 ‚Üí –ø–æ–ª—É—á–∏–ª–∏ email ‚Üí –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
* fallback: unreachable ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ fake email

–í —Ç–µ—Å—Ç–∞—Ö:

* AuthClient –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ FakeAuthClient
* —Ç–µ—Å—Ç—ã Worker –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ consumer, –∞ –Ω–µ —Å–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã

–≠—Ç–æ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:
—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –±—ã—Å—Ç—Ä—ã–º, –∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã—Ç.

---

# üî• **–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Campaign Scheduler**

–î–ª—è scheduler –º—ã —Å–¥–µ–ª–∞–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:

* –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (last_triggered_at = NULL)
* max_runs –¥–æ—Å—Ç–∏–≥–Ω—É—Ç ‚Üí job –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
* cron-–æ–∫–Ω–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ ‚Üí –∑–∞–ø—É—Å–∫
* cron-–æ–∫–Ω–æ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ ‚Üí –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å

–í—Å–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç unit-–≤–∞—Ä–∏–∞–Ω—Ç CampaignModel, –Ω–µ —Ç—Ä–µ–±—É—é—â–∏–π –î–ë.

---

# üî• **–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª: –ß—Ç–æ –º—ã –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏ –ø–æ—á–µ–º—É**

## –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:

### ‚ùå –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é Kafka ‚Üí Worker

–ü–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–∫–∞ —É—Ä–æ–≤–Ω–µ–º –≤—ã—à–µ –ø—Ä–æ–µ–∫—Ç–∞.
–°–ø—Ä–∏–Ω—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–Ω—è—Ç–∏–µ Kafka –≤ —Ç–µ—Å—Ç–∞—Ö.

### ‚ùå –æ—Ç–ø—Ä–∞–≤–∫—É email/push/ws —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º

–£ –Ω–∞—Å —á–∏—Å—Ç—ã–π sender, –∫–æ—Ç–æ—Ä—ã–π –ª–æ–≥–∏—Ä—É–µ—Ç ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–ª—è MVP.

### ‚ùå –ø–æ–ª–Ω—ã–π E2E Auth ‚Üí API ‚Üí Kafka ‚Üí Worker ‚Üí DB

–≠—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å.
–í —Å–ø—Ä–∏–Ω—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:
**–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ –Ω—É–∂–Ω–æ –ø–æ–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ API –∏ Worker**.

---

# üî• –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª: –ö–∞–∫–∞—è —á–∞—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É?

| –ü—É–Ω–∫—Ç —á–µ–∫-–ª–∏—Å—Ç–∞                | –£ –Ω–∞—Å | –°—Ç–∞—Ç—É—Å                      |
| ------------------------------ | ----- | --------------------------- |
| API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è          | ‚úî     | –≤—ã–ø–æ–ª–Ω–µ–Ω–æ                   |
| API –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å       | ‚úî     | —Ñ–µ–π–∫–æ–≤—ã–π publisher          |
| Worker –∑–∞–±–∏—Ä–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç | ‚úî     | –≤—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ           |
| Worker –¥–µ–ª–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é   | ‚úî     | Auth HTTP client            |
| Worker –¥–µ–ª–∞–µ—Ç retry + DLQ      | ‚úî     | –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ              |
| Worker –ø–∏—à–µ—Ç –∏—Å—Ç–æ—Ä–∏—é           | ‚úî     | —á–µ—Ä–µ–∑ mock DB writer        |
| –†–∞—Å—Å—ã–ª–∫–∏ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º/–∫–∞–º–ø–∞–Ω–∏–∏ | ‚úî     | scheduler + docs            |
| Websocket                      | ‚Äì     | –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ |
| Short links                    | ‚Äì     | –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω               |
| Admin UI                       | ‚Äì     | –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω               |

---
