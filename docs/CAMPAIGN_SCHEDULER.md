
---

# üìò **CAMPAIGN_SCHEDULER.md**

**–ú–µ—Ö–∞–Ω–∏–∑–º –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –≤ Notification Service**

–î–æ–∫—É–º–µ–Ω—Ç –æ–±—ä—è—Å–Ω—è–µ—Ç:

* —á—Ç–æ —Ç–∞–∫–æ–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è;
* –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–∞–º–ø–∞–Ω–∏–π (campaign scheduler);
* –∫–∞–∫ –æ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è `campaign_triggered`;
* –∫–∞–∫ —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Notification API –∏ –¥–∞–ª–µ–µ –≤ Worker.

---

# 1. –ß—Ç–æ —Ç–∞–∫–æ–µ –∫–∞–º–ø–∞–Ω–∏—è

–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è ‚Äî —ç—Ç–æ –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `campaigns`, –∫–æ—Ç–æ—Ä–∞—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç:

| –ü–æ–ª–µ                | –û–ø–∏—Å–∞–Ω–∏–µ                                            |
| ------------------- | --------------------------------------------------- |
| `template_code`     | –∫–∞–∫–æ–π —à–∞–±–ª–æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                           |
| `segment_id`        | —Å–µ–≥–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è |
| `schedule_cron`     | —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ cron                           |
| `status`            | `ACTIVE`, `INACTIVE`, `PAUSED`                      |
| `last_triggered_at` | –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å `NULL`)        |
| `runs_count`        | —Å–∫–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–æ–≤ –±—ã–ª–æ                               |
| `max_runs`          | –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ (‚àû –µ—Å–ª–∏ `NULL`)    |

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏

```sql
INSERT INTO campaigns (
    id,
    name,
    template_code,
    segment_id,
    schedule_cron,
    status,
    max_runs
) VALUES (
    gen_random_uuid(),
    'Promo to premium users',
    'new_features',
    'segment_premium_users',
    '* * * * *',   -- –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    'ACTIVE',
    3
);
```

---

# 2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Campaign Scheduler

Scheduler ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–∂–¥—ã–µ **N —Å–µ–∫—É–Ω–¥**:

1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `ACTIVE`.
2. –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –ø–æ—Ä–∞ –ª–∏ –µ—ë –∑–∞–ø—É—Å–∫–∞—Ç—å:

   * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç `max_runs`;
   * —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `last_triggered_at` —Å cron-—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º.
3. –ï—Å–ª–∏ –∫–∞–º–ø–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `campaign_triggered` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Notification API.
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ API ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ –≤ Postgres:

   * `last_triggered_at = NOW()`;
   * `runs_count = runs_count + 1`;
   * –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç `max_runs` ‚Äî –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç `status = INACTIVE`.

–ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî scheduler –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

---

# 3. Cron-–ª–æ–≥–∏–∫–∞

–§—É–Ω–∫—Ü–∏—è `is_campaign_due(campaign, now)` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ –∫ –∑–∞–ø—É—Å–∫—É:

1. –ï—Å–ª–∏ `max_runs` –∑–∞–¥–∞–Ω –∏ `runs_count >= max_runs` ‚Üí –∫–∞–º–ø–∞–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.
2. –ï—Å–ª–∏ `last_triggered_at IS NULL` ‚Üí —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫, cam–ø–∞–Ω–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É.
3. –ò–Ω–∞—á–µ:

   * `base = last_triggered_at`;
   * `next_run = croniter(schedule_cron, base).get_next()`;
   * –µ—Å–ª–∏ `next_run <= now` ‚Üí –ø–æ—Ä–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å.

–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ cron-–≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è, –æ—à–∏–±–∫–∞ –ø–∏—à–µ—Ç—Å—è –≤ –ª–æ–≥.

---

# 4. –§–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ –≤ API

Scheduler –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–≥–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Å–æ–±—ã—Ç–∏–µ:

`POST /api/v1/events`

```json
{
  "event_id": "uuid",
  "event_type": "campaign_triggered",
  "source": "campaign_scheduler",
  "occurred_at": "2025-11-21T12:00:00Z",
  "payload": {
    "campaign_id": "uuid",
    "template_code": "new_features",
    "channels": ["email"],
    "segment": {
      "segment_id": "segment_premium_users"
    }
  }
}
```

---

# 5. Payload `campaign_triggered` –≤ Notification API

–ú–æ–¥–µ–ª—å –≤ API:

```python
class CampaignTriggeredSegment(BaseModel):
    segment_id: str


class CampaignTriggeredEventPayload(BaseModel):
    campaign_id: UUID
    template_code: str
    channels: List[str]
    segment: CampaignTriggeredSegment
```

Notification API –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç payload –∏–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–∏–º –ø–æ–ª—è–º.

---

# 6. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Notification API

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:

1. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç `BaseEvent`.
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `event_type == "campaign_triggered"`.
3. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç payload –∫–∞–∫ `CampaignTriggeredEventPayload`.
4. –ü–µ—Ä–µ–¥–∞—ë—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `NotificationService`.
5. `NotificationService`:

   * –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ–≥–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ `segment_id`;
   * —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `NotificationJob`;
   * –ø—É–±–ª–∏–∫—É–µ—Ç –∑–∞–¥–∞–Ω–∏—è –≤ Kafka ‚Äî `notifications.outbox`.

API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```json
{
  "status": "accepted",
  "event_id": "...",
  "jobs_count": N
}
```

---

# 7. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç worker

Worker:

1. –ß–∏—Ç–∞–µ—Ç job –∏–∑ Kafka.
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (`job_id`).
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Auth.
4. –†–µ–Ω–¥–µ—Ä–∏—Ç —à–∞–±–ª–æ–Ω.
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
6. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å (`SENT`, `FAILED`, `RETRYING`, `EXPIRED`).
7. –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫:

   * –¥–µ–ª–∞–µ—Ç retry;
   * –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç job –≤ `notifications.dlq`.

---

# 8. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∫–∞–º–ø–∞–Ω–∏–∏

1. –ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ —Å–æ–∑–¥–∞—ë—Ç –∫–∞–º–ø–∞–Ω–∏—é –≤ –ë–î (`status = ACTIVE`, `runs_count = 0`).
2. Scheduler —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–∞.
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç HTTP POST ‚Üí `/events` –≤ Notification API.
4. Notification API –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–∞—á–∫—É job –≤ Kafka.
5. Worker –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
6. Scheduler –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏.
7. –ö–∞–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç –ª–∏–º–∏—Ç–∞.
8. –ö–æ–≥–¥–∞ –ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç ‚Äî `status = INACTIVE`.

---

# 9. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è MVP

* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ email-–∫–∞–Ω–∞–ª.
* `segment_id` ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Ä–µ–∞–ª—å–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç–∞—Ç–æ—Ä –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω).
* Cron-–ª–æ–≥–∏–∫–∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã.
* –ù–µ—Ç API –¥–ª—è CRUD –∫–∞–º–ø–∞–Ω–∏–π ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ë–î.

---

# 10. –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å

* API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è/–ø–∞—É–∑—ã –∫–∞–º–ø–∞–Ω–∏–π.
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ (`email`, `push`, `sms`).
* –†–µ–∞–ª—å–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç–∞—Ç–æ—Ä (–ø–æ –∂–∞–Ω—Ä–∞–º, –≤–æ–∑—Ä–∞—Å—Ç—É, —Å—Ç—Ä–∞–Ω–∞–º).
* –°–∫–≤–æ–∑–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π.
* –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π cron-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (—É—á–∏—Ç—ã–≤–∞—é—â–∏–π –ø—Ä–æ–ø—É—Å–∫–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏).

---
